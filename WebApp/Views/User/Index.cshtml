@{
    ViewData["Title"] = "User Management";
}

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h2>User Management</h2>
        </div>
    </div>

    <div id="alertContainer"></div>

    <div class="card">
        <div class="card-body">
            <table class="table table-striped table-hover">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Tên đầy đủ</th>
                    <th>Email</th>
                    <th>Số điện thoại</th>
                    <th>Trung tâm</th>
                    <th>Vai trò</th>
                    <th>Trạng thái</th>
                    <th>Hành động</th>
                </tr>
                </thead>
                <tbody id="userTableBody">
                <tr>
                    <td colspan="9" class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
            </div>
    </div>
</div>

<div class="modal fade" id="userDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">User Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="userDetailsBody">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script src="~/js/api-helper.js"></script>
<script>
    const UserManager = {
        init: function() {
            Auth.checkAccessToken();
            this.loadUsers();
        },

        loadUsers: function() {
            const page = 1;
            const limit = 10;

            ApiHelper.request(`/api/user/users?page=${page}&limit=${limit}`, 'GET')
                .done((response) => {
                    this.renderUsers(response.items);
                })
                .fail(() => {
                    $('#userTableBody').html('<tr><td colspan="9" class="text-center text-danger">Failed to load users</td></tr>');
                });
        },

        renderUsers: function(users) {
            if (!users || users.length === 0) {
                $('#userTableBody').html('<tr><td colspan="9" class="text-center">No users found</td></tr>');
                return;
            }

            let html = '';
            users.forEach(user => {
                const isActive = user.status === 'Active';
                const statusBadge = isActive
                    ? '<span class="badge bg-success">Active</span>'
                    : '<span class="badge bg-secondary">Inactive</span>';

                html += `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.username}</td>
                            <td>${user.fullName}</td>
                            <td>${user.email}</td>
                            <td>${user.phoneNumber || '-'}</td>
                            <td>${user.centerName || '-'}</td>
                            <td>${user.roleName}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="UserManager.showDetails(${user.id})">Details</button>
                                <button class="btn btn-sm ${isActive ? 'btn-warning' : 'btn-success'}" 
                                        onclick="UserManager.toggleStatus(${user.id}, ${!isActive})">
                                    ${isActive ? 'Deactivate' : 'Activate'}
                                </button>
                            </td>
                        </tr>
                    `;
            });
            $('#userTableBody').html(html);
        },

        showDetails: function(userId) {
            $('#userDetailsBody').html(`
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                `);
            $('#userDetailsModal').modal('show');

            ApiHelper.request(`/api/user/users/${userId}/details`, 'GET')
                .done((response) => {
                    this.renderDetails(response);
                })
                .fail(() => {
                    $('#userDetailsBody').html('<div class="alert alert-danger">Failed to load user details</div>');
                });
        },

        renderDetails: function(user) {
            const userIsActive = user.userStatus === 'Active';
            const userStatusBadge = userIsActive ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>';
            const userHtml = `
                <h6>Personal Information</h6>
                <table class="table table-sm table-bordered">
                    <tr><th>ID:</th><td>${user.id}</td></tr>
                    <tr><th>Username:</th><td>${user.username}</td></tr>
                    <tr><th>Full Name:</th><td>${user.fullName}</td></tr>
                    <tr><th>Email:</th><td>${user.email}</td></tr>
                    <tr><th>Phone:</th><td>${user.phoneNumber || '-'}</td></tr>
                    <tr><th>Role:</th><td>${user.roleName}</td></tr>
                    <tr><th>Status:</th><td>${userStatusBadge}</td></tr>
                    <tr><th>Created At:</th><td>${new Date(user.createdAt).toLocaleString()}</td></tr>
                </table>
            `;

            const centerIsActive = user.centerStatus === 'Active';
            const centerStatusBadge = centerIsActive ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>';
            const centerHtml = `
                <h6>Center Information</h6>
                <table class="table table-sm table-bordered">
                    <tr><th>ID:</th><td>${user.centerId}</td></tr>
                    <tr><th>Name:</th><td>${user.centerName}</td></tr>
                    <tr><th>Address:</th><td>${user.centerAddress || '-'}</td></tr>
                    <tr><th>Email:</th><td>${user.centerEmail}</td></tr>
                    <tr><th>Status:</th><td>${centerStatusBadge}</td></tr>
                </table>
            `;

            let classesHtml = '<h6>Enrolled Classes</h6>';
            if (user.classes && user.classes.length > 0) {
                classesHtml += '<ul class="list-group">';
                user.classes.forEach(cls => {
                    const classStatus = cls.status === 'Active' ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>';
                    const startDate = cls.startDate ? new Date(cls.startDate).toLocaleDateString() : 'N/A';
                    const endDate = cls.endDate ? new Date(cls.endDate).toLocaleDateString() : 'N/A';
                    
                    classesHtml += `
                        <li class="list-group-item d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${cls.className}</strong> (ID: ${cls.classId})
                                <br><small class="text-muted">Joined: ${new Date(cls.joinedAt).toLocaleDateString()}</small>
                                <br><small class="text-muted">Time: ${startDate} - ${endDate}</small>
                            </div>
                            ${classStatus}
                        </li>
                    `;
                });
                classesHtml += '</ul>';
            } else {
                classesHtml += '<p class="text-muted">Not enrolled in any classes</p>';
            }

            $('#userDetailsBody').html(`
                <div class="row">
                    <div class="col-md-6">${userHtml}</div>
                    <div class="col-md-6">${centerHtml}</div>
                </div>
                <hr>
                ${classesHtml}
            `);
        },

        toggleStatus: function(userId, isActive) {
            const actionText = isActive ? 'activate' : 'deactivate';
            if (!confirm(`Are you sure you want to ${actionText} this user?`)) {
                return;
            }

            ApiHelper.request(`/api/user/users/${userId}/active/${isActive}`, 'PUT')
                .done((response) => {
                    ApiHelper.showAlert('Status updated successfully', 'success');
                    this.loadUsers();
                })
                .fail((xhr) => {
                    const message = xhr.responseJSON?.message || 'Failed to update status';
                    ApiHelper.showAlert(message, 'danger');
                });
        }
    };

    $(document).ready(() => UserManager.init());
</script>
}