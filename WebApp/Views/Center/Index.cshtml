@{
ViewData["Title"] = "Center Management";
}

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h2>Center Management</h2>
        </div>
    </div>

    <div id="alertContainer"></div>

    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <label for="limitSelector" class="me-2">Line number</label>
                    <select id="limitSelector" class="form-select form-select-sm d-inline-block w-auto">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                </div>
            </div>
            <table class="table table-striped table-hover">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Center Name</th>
                    <th>Manager Name</th>
                    <th>Address</th>
                    <th>Email</th>
                    <th>Phone Number</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
                </thead>
                <tbody id="centerTableBody">
                <tr>
                    <td colspan="8" class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-end" id="paginationControls">
                </ul>
            </nav>
        </div>
    </div>
</div>

<div class="modal fade" id="centerDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Center Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="centerDetailsBody">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script src="~/js/api-helper.js"></script>
<script>
    const CenterManager = {
        currentPage: 1,
        currentLimit: 10,
        totalPages: 1,
        
        init: function() {
            Auth.checkAccessToken();
            this.loadCenters();
            this.bindEvents();
        },

        bindEvents: function() {
            const self = this;
            $('#paginationControls').on('click', 'a.page-link', function(e) {
                e.preventDefault();
                const $parent = $(this).parent();

                if ($parent.hasClass('disabled') || $parent.hasClass('active')) {
                    return;
                }

                const page = $(this).data('page');
                if (page) {
                    self.currentPage = parseInt(page);
                    self.loadCenters();
                }
            });

            $('#limitSelector').on('change', function() {
                const newLimit = parseInt($(this).val());

                if (isNaN(newLimit) || newLimit <= 0) {
                    console.error("Invalid limit value received.");
                    return;
                }

                self.currentLimit = newLimit;
                self.currentPage = 1;
                self.loadCenters();
            });
        },

        loadCenters: function() {
            $('#centerTableBody').html(`
                <tr>
                    <td colspan="9" class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </td>
                </tr>
            `);
            
            ApiHelper.request(`/api/center/centers?page=${this.currentPage}&limit=${this.currentLimit}`, 'GET')
                .done((response) => {
                    this.renderCenters(response.items)
                    
                    this.totalPages = response.totalPages || 1;
                    this.currentPage = response.currentPage || 1;
                    
                    this.renderPagination();
                })
                .fail(() => {
                    $('#centerTableBody').html('<tr><td colspan="8" class="text-center text-danger">Failed to load centers</td></tr>');
                    $('#paginationControls').empty();
                });
        },

        renderCenters: function(centers) {
            if (!centers || centers.length === 0) {
                $('#centerTableBody').html('<tr><td colspan="8" class="text-center">No centers found</td></tr>');
                return;
            }

            let html = '';
            centers.forEach(center => {
                const isActive = center.status === 'Active';
                const statusBadge = isActive
                    ? '<span class="badge bg-success">Active</span>'
                    : '<span class="badge bg-secondary">Inactive</span>';

                html += `
                        <tr>
                            <td>${center.id}</td>
                            <td>${center.name}</td>
                            <td>${center.managerName || '-'}</td>
                            <td>${center.address || '-'}</td>
                            <td>${center.email}</td>
                            <td>${center.phoneNumber || '-'}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="CenterManager.showDetails(${center.id})">Details</button>
                                <button class="btn btn-sm ${isActive ? 'btn-warning' : 'btn-success'}" 
                                        onclick="CenterManager.toggleStatus(${center.id}, ${!isActive})">
                                    ${isActive ? 'Deactivate' : 'Activate'}
                                </button>
                            </td>
                        </tr>
                    `;
            });
            $('#centerTableBody').html(html);
        },

        renderPagination: function() {
            const $container = $('#paginationControls');
            $container.empty();

            if (this.totalPages <= 1) {
                return;
            }

            let html = '';
            const maxVisiblePages = 5;
            const halfMax = Math.floor(maxVisiblePages / 2);
            const startPage = Math.max(1, this.currentPage - halfMax);
            const endPage = Math.min(this.totalPages, this.currentPage + halfMax);

            const createPageItem = (page, text, isDisabled = false, isActive = false) => {
                const disabledClass = isDisabled ? 'disabled' : '';
                const activeClass = isActive ? 'active' : '';
                return `<li class="page-item ${disabledClass} ${activeClass}">
                            <a class="page-link" href="#" data-page="${page}">${text}</a>
                        </li>`;
            };

            html += createPageItem(this.currentPage - 1, 'Previous', this.currentPage === 1);

            let pages = [];

            pages.push(1);

            for (let i = startPage; i <= endPage; i++) {
                if (i !== 1 && i !== this.totalPages) {
                    pages.push(i);
                }
            }

            if (this.totalPages > 1) {
                pages.push(this.totalPages);
            }

            pages = [...new Set(pages)].sort((a, b) => a - b);

            let lastPageAdded = 0;
            pages.forEach(page => {

                if (page - lastPageAdded > 1) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }

                html += createPageItem(page, page, false, page === this.currentPage);
                lastPageAdded = page;
            });

            html += createPageItem(this.currentPage + 1, 'Next', this.currentPage === this.totalPages);

            $container.html(html);
        },

        showDetails: function(centerId) {
            $('#centerDetailsBody').html(`
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                `);
            $('#centerDetailsModal').modal('show');

            ApiHelper.request(`/api/center/centers/${centerId}/details`, 'GET')
                .done((response) => {
                    this.renderDetails(response.center, response.users, response.classes);
                })
                .fail(() => {
                    $('#centerDetailsBody').html('<div class="alert alert-danger">Failed to load center details</div>');
                });
        },

        renderDetails: function(center, users, classes) {
            const centerIsActive = center.status === 'Active';
            const centerStatusBadge = centerIsActive ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>';

            const centerHtml = `
                    <h6>Center Information</h6>
                    <table class="table table-sm table-bordered">
                        <tr><th>ID:</th><td>${center.id}</td></tr>
                        <tr><th>Name:</th><td>${center.name}</td></tr>
                        <tr><th>Manager:</th><td>${center.managerName || '-'}</td></tr>
                        <tr><th>Address:</th><td>${center.address || '-'}</td></tr>
                        <tr><th>Email:</th><td>${center.email}</td></tr>
                        <tr><th>Phone:</th><td>${center.phoneNumber || '-'}</td></tr>
                        <tr><th>Status:</th><td>${centerStatusBadge}</td></tr>
                        <tr><th>Created:</th><td>${new Date(center.createdAt).toLocaleDateString()}</td></tr>
                    </table>
                `;

            let usersHtml = '<h6>Users in Center</h6>';
            if (users && users.length > 0) {
                usersHtml += '<ul class="list-group mb-3">';
                users.forEach(user => {
                    const userStatus = user.status === 'Active' ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>';
                    usersHtml += `
                            <li class="list-group-item d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>${user.fullName}</strong> (${user.roleName})
                                    <br><small class="text-muted">${user.email} | ${user.username}</small>
                                </div>
                                ${userStatus}
                            </li>
                        `;
                });
                usersHtml += '</ul>';
            } else {
                usersHtml += '<p class="text-muted">No users found in this center</p>';
            }

            let classesHtml = '<h6>Classes in Center</h6>';
            if (classes && classes.length > 0) {
                classesHtml += '<ul class="list-group">';
                classes.forEach(cls => {
                    const classStatus = cls.status === 'Active' ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>';
                    const startDate = cls.startDate ? new Date(cls.startDate).toLocaleDateString() : 'N/A';
                    const endDate = cls.endDate ? new Date(cls.endDate).toLocaleDateString() : 'N/A';

                    classesHtml += `
                            <li class="list-group-item d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>${cls.name}</strong>
                                    <br><small class="text-muted">Time: ${startDate} - ${endDate}</small>
                                </div>
                                ${classStatus}
                            </li>
                        `;
                });
                classesHtml += '</ul>';
            } else {
                classesHtml += '<p class="text-muted">No classes found in this center</p>';
            }

            $('#centerDetailsBody').html(`
                    ${centerHtml}
                    <hr>
                    <div class="row">
                        <div class="col-md-6">${usersHtml}</div>
                        <div class="col-md-6">${classesHtml}</div>
                    </div>
                `);
        },

        toggleStatus: function(centerId, isActive) {
            const actionText = isActive ? 'activate' : 'deactivate';
            if (!confirm(`Are you sure you want to ${actionText} this center?`)) {
                return;
            }

            ApiHelper.request(`/api/center/centers/${centerId}/active/${isActive}`, 'PUT')
                .done((response) => {
                    ApiHelper.showAlert('Status updated successfully', 'success');
                    this.loadCenters();
                })
                .fail((xhr) => {
                    const message = xhr.responseJSON?.message || 'Failed to update status';
                    ApiHelper.showAlert(message, 'danger');
                });
        }
    };

    $(document).ready(() => CenterManager.init());
</script>
}