@{
    ViewData["Title"] = "Student Management";
}

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h2>Student Management</h2>
        </div>
    </div>

    <div id="alertContainer"></div>

    <div class="card">
        <div class="card-body">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Full Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Center</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="studentTableBody">
                    <tr>
                        <td colspan="8" class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="studentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Student</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="studentForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="fullName" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="fullName" required>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="phoneNumber" class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="phoneNumber">
                    </div>
                    <div class="alert alert-info">
                        <small>Default password: Student@123</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveStudentBtn">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="studentDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Student Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="studentDetailsBody">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/config.js"></script>
    <script src="~/js/auth.js"></script>
    <script src="~/js/api-helper.js"></script>
    <script>
        const StudentManager = {
            init: function() {
                Auth.checkAccessToken();
                this.loadStudents();
                this.bindEvents();
            },

            bindEvents: function() {
                $('#studentForm').submit((e) => {
                    e.preventDefault();
                    this.createStudent();
                });
            },

            loadStudents: function() {
                ApiHelper.request('/api/student', 'GET')
                    .done((response) => {
                        this.renderStudents(response.data);
                    })
                    .fail(() => {
                        $('#studentTableBody').html('<tr><td colspan="8" class="text-center text-danger">Failed to load students</td></tr>');
                    });
            },

            renderStudents: function(students) {
                if (students.length === 0) {
                    $('#studentTableBody').html('<tr><td colspan="8" class="text-center">No students found</td></tr>');
                    return;
                }

                let html = '';
                students.forEach(student => {
                    const statusBadge = student.isActive 
                        ? '<span class="badge bg-success">Active</span>' 
                        : '<span class="badge bg-secondary">Inactive</span>';

                    html += `
                        <tr>
                            <td>${student.id}</td>
                            <td>${student.username}</td>
                            <td>${student.fullName}</td>
                            <td>${student.email}</td>
                            <td>${student.phoneNumber || '-'}</td>
                            <td>${student.centerName}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="StudentManager.showDetails(${student.id})">Details</button>
                                <button class="btn btn-sm ${student.isActive ? 'btn-warning' : 'btn-success'}" 
                                        onclick="StudentManager.toggleStatus(${student.id}, ${!student.isActive})">
                                    ${student.isActive ? 'Deactivate' : 'Activate'}
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="StudentManager.deleteStudent(${student.id})">Delete</button>
                            </td>
                        </tr>
                    `;
                });
                $('#studentTableBody').html(html);
            },

            showCreateModal: function() {
                $('#studentForm')[0].reset();
            },

            createStudent: function() {
                const data = {
                    fullName: $('#fullName').val(),
                    email: $('#email').val(),
                    phoneNumber: $('#phoneNumber').val() || null
                };

                $('#saveStudentBtn').prop('disabled', true).text('Saving...');

                ApiHelper.request('/api/student', 'POST', data)
                    .done((response) => {
                        ApiHelper.showAlert(response.message, 'success');
                        $('#studentModal').modal('hide');
                        this.loadStudents();
                    })
                    .fail((xhr) => {
                        const message = xhr.responseJSON?.message || 'Failed to create student';
                        ApiHelper.showAlert(message, 'danger');
                    })
                    .always(() => {
                        $('#saveStudentBtn').prop('disabled', false).text('Save');
                    });
            },

            showDetails: function(studentId) {
                $('#studentDetailsBody').html(`
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                `);
                $('#studentDetailsModal').modal('show');

                ApiHelper.request(`/api/student/${studentId}/details`, 'GET')
                    .done((response) => {
                        this.renderDetails(response.data);
                    })
                    .fail(() => {
                        $('#studentDetailsBody').html('<div class="alert alert-danger">Failed to load student details</div>');
                    });
            },

            renderDetails: function(student) {
                let classesHtml = '';
                if (student.classes && student.classes.length > 0) {
                    classesHtml = '<ul class="list-group">';
                    student.classes.forEach(cls => {
                        const statusBadge = cls.isActive ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>';
                        classesHtml += `
                            <li class="list-group-item">
                                <strong>${cls.className}</strong> ${statusBadge}
                                <br>
                                <small>Joined: ${new Date(cls.joinedAt).toLocaleDateString()}</small>
                                ${cls.startDate ? `<br><small>Start: ${new Date(cls.startDate).toLocaleDateString()}</small>` : ''}
                                ${cls.endDate ? `<br><small>End: ${new Date(cls.endDate).toLocaleDateString()}</small>` : ''}
                            </li>
                        `;
                    });
                    classesHtml += '</ul>';
                } else {
                    classesHtml = '<p class="text-muted">Not enrolled in any classes</p>';
                }

                const html = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Personal Information</h6>
                            <table class="table table-sm">
                                <tr><th>ID:</th><td>${student.id}</td></tr>
                                <tr><th>Username:</th><td>${student.username}</td></tr>
                                <tr><th>Full Name:</th><td>${student.fullName}</td></tr>
                                <tr><th>Email:</th><td>${student.email}</td></tr>
                                <tr><th>Phone:</th><td>${student.phoneNumber || '-'}</td></tr>
                                <tr><th>Status:</th><td>${student.isActive ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>'}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Center Information</h6>
                            <table class="table table-sm">
                                <tr><th>Center:</th><td>${student.centerName}</td></tr>
                                <tr><th>Address:</th><td>${student.centerAddress}</td></tr>
                                <tr><th>Email:</th><td>${student.centerEmail}</td></tr>
                            </table>
                        </div>
                    </div>
                    <hr>
                    <h6>Enrolled Classes</h6>
                    ${classesHtml}
                `;
                $('#studentDetailsBody').html(html);
            },

            toggleStatus: function(studentId, isActive) {
                if (!confirm(`Are you sure you want to ${isActive ? 'activate' : 'deactivate'} this student?`)) {
                    return;
                }

                const data = { id: studentId, isActive: isActive };

                ApiHelper.request('/api/student/active', 'PUT', data)
                    .done((response) => {
                        ApiHelper.showAlert(response.message, 'success');
                        this.loadStudents();
                    })
                    .fail((xhr) => {
                        const message = xhr.responseJSON?.message || 'Failed to update status';
                        ApiHelper.showAlert(message, 'danger');
                    });
            },

            deleteStudent: function(studentId) {
                if (!confirm('Are you sure you want to delete this student? This action cannot be undone.')) {
                    return;
                }

                ApiHelper.request(`/api/student/${studentId}`, 'DELETE')
                    .done((response) => {
                        ApiHelper.showAlert(response.message, 'success');
                        this.loadStudents();
                    })
                    .fail((xhr) => {
                        const message = xhr.responseJSON?.message || 'Failed to delete student';
                        ApiHelper.showAlert(message, 'danger');
                    });
            }
        };

        $(document).ready(() => StudentManager.init());
    </script>
}

